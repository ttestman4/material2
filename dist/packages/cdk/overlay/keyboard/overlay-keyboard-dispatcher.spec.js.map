{"version":3,"file":"overlay-keyboard-dispatcher.spec.js","sourceRoot":"","sources":["../../../../../src/cdk/overlay/keyboard/overlay-keyboard-dispatcher.spec.ts"],"names":[],"mappings":";;;;;;;;AAAA,iDAAsD;AACtD,gDAA2D;AAC3D,kDAA6C;AAC7C,sCAAkD;AAClD,kCAAkE;AAClE,6EAAwE;AACxE,8CAAoD;AAGpD,QAAQ,CAAC,2BAA2B,EAAE;IACpC,IAAI,kBAA6C,CAAC;IAClD,IAAI,OAAgB,CAAC;IAErB,UAAU,CAAC;QACT,iBAAO,CAAC,sBAAsB,CAAC;YAC7B,OAAO,EAAE,CAAC,qBAAa,EAAE,mBAAmB,CAAC;SAC9C,CAAC,CAAC;QAEH,gBAAM,CAAC,CAAC,uDAAyB,EAAE,eAAO,CAAC,EAAE,UAAC,GAA8B,EAAE,CAAU;YACtF,kBAAkB,GAAG,GAAG,CAAC;YACzB,OAAO,GAAG,CAAC,CAAC;QACd,CAAC,CAAC,EAAE,CAAC;IACP,CAAC,CAAC,CAAC;IAEH,SAAS,CAAC,gBAAM,CAAC,CAAC,wBAAgB,CAAC,EAAE,UAAC,gBAAkC;QACtE,gBAAgB,CAAC,WAAW,EAAE,CAAC;IACjC,CAAC,CAAC,CAAC,CAAC;IAEJ,EAAE,CAAC,kEAAkE,EAAE;QACrE,IAAM,UAAU,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC;QACpC,IAAM,UAAU,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC;QAEpC,kBAAkB;QAClB,kBAAkB,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;QACnC,kBAAkB,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;QAEnC,MAAM,CAAC,kBAAkB,CAAC,iBAAiB,CAAC,MAAM,CAAC;aAC9C,IAAI,CAAC,CAAC,EAAE,uCAAuC,CAAC,CAAC;QACtD,MAAM,CAAC,kBAAkB,CAAC,iBAAiB,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,UAAU,EAAE,2BAA2B,CAAC,CAAC;QAC9F,MAAM,CAAC,kBAAkB,CAAC,iBAAiB,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,UAAU,EAAE,0BAA0B,CAAC,CAAC;QAE7F,oCAAoC;QACpC,kBAAkB,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;QACtC,kBAAkB,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;QAEnC,MAAM,CAAC,kBAAkB,CAAC,iBAAiB,CAAC,CAAC,CAAC,CAAC;aAC1C,IAAI,CAAC,UAAU,EAAE,+BAA+B,CAAC,CAAC;QACvD,MAAM,CAAC,kBAAkB,CAAC,iBAAiB,CAAC,CAAC,CAAC,CAAC;aAC1C,IAAI,CAAC,UAAU,EAAE,8BAA8B,CAAC,CAAC;IACxD,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,4EAA4E,EAAE;QAC/E,IAAM,UAAU,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC;QACpC,IAAM,UAAU,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC;QACpC,IAAM,aAAa,GAAG,OAAO,CAAC,SAAS,CAAC,+BAA+B,CAAC,CAAC;QACzE,IAAM,aAAa,GAAG,OAAO,CAAC,SAAS,CAAC,+BAA+B,CAAC,CAAC;QAEzE,UAAU,CAAC,aAAa,EAAE,CAAC,SAAS,CAAC,aAAa,CAAC,CAAC;QACpD,UAAU,CAAC,aAAa,EAAE,CAAC,SAAS,CAAC,aAAa,CAAC,CAAC;QAEpD,kBAAkB;QAClB,kBAAkB,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;QACnC,kBAAkB,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;QAEnC,+BAAqB,CAAC,QAAQ,CAAC,IAAI,EAAE,SAAS,EAAE,iBAAM,CAAC,CAAC;QAExD,2CAA2C;QAC3C,MAAM,CAAC,aAAa,CAAC,CAAC,GAAG,CAAC,gBAAgB,EAAE,CAAC;QAC7C,MAAM,CAAC,aAAa,CAAC,CAAC,gBAAgB,EAAE,CAAC;IAC3C,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,6DAA6D,EAAE;QAChE,IAAM,UAAU,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC;QACpC,IAAM,GAAG,GAAG,OAAO,CAAC,SAAS,CAAC,oBAAoB,CAAC,CAAC;QACpD,IAAM,MAAM,GAAG,QAAQ,CAAC,aAAa,CAAC,QAAQ,CAAC,CAAC;QAEhD,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;QAClC,MAAM,CAAC,gBAAgB,CAAC,SAAS,EAAE,UAAA,KAAK,IAAI,OAAA,KAAK,CAAC,eAAe,EAAE,EAAvB,CAAuB,CAAC,CAAC;QAErE,UAAU,CAAC,aAAa,EAAE,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC;QAC1C,kBAAkB,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;QACnC,+BAAqB,CAAC,MAAM,EAAE,SAAS,EAAE,iBAAM,CAAC,CAAC;QAEjD,MAAM,CAAC,GAAG,CAAC,CAAC,gBAAgB,EAAE,CAAC;QAE/B,MAAM,CAAC,UAAW,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;IACzC,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,+CAA+C,EAAE;QAClD,IAAM,UAAU,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC;QACpC,IAAM,WAAW,GAAG,OAAO,CAAC,SAAS,CAAC,sBAAsB,CAAC,CAAC;QAE9D,UAAU,CAAC,aAAa,EAAE,CAAC,SAAS,CAAC,SAAS,EAAE,SAAS,EAAE,WAAW,CAAC,CAAC;QAExE,UAAU,CAAC,OAAO,EAAE,CAAC;QAErB,MAAM,CAAC,WAAW,CAAC,CAAC,gBAAgB,EAAE,CAAC;IACzC,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,kDAAkD,EAAE;QACrD,IAAM,QAAQ,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC;QAClC,IAAM,GAAG,GAAG,OAAO,CAAC,SAAS,CAAC,oBAAoB,CAAC,CAAC;QAEpD,QAAQ,CAAC,MAAM,CAAC,IAAI,wBAAe,CAAC,aAAa,CAAC,CAAC,CAAC;QACpD,QAAQ,CAAC,aAAa,EAAE,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC;QAExC,+BAAqB,CAAC,QAAQ,CAAC,IAAI,EAAE,SAAS,EAAE,iBAAM,EAAE,QAAQ,CAAC,cAAc,CAAC,CAAC;QACjF,MAAM,CAAC,GAAG,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QAErC,QAAQ,CAAC,MAAM,EAAE,CAAC;QAClB,+BAAqB,CAAC,QAAQ,CAAC,IAAI,EAAE,SAAS,EAAE,iBAAM,EAAE,QAAQ,CAAC,cAAc,CAAC,CAAC;QAEjF,MAAM,CAAC,GAAG,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;IACvC,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,kDAAkD,EAAE;QACrD,IAAM,QAAQ,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC;QAClC,IAAM,GAAG,GAAG,OAAO,CAAC,SAAS,CAAC,oBAAoB,CAAC,CAAC;QAEpD,QAAQ,CAAC,MAAM,CAAC,IAAI,wBAAe,CAAC,aAAa,CAAC,CAAC,CAAC;QACpD,QAAQ,CAAC,aAAa,EAAE,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC;QAExC,+BAAqB,CAAC,QAAQ,CAAC,IAAI,EAAE,SAAS,EAAE,iBAAM,EAAE,QAAQ,CAAC,cAAc,CAAC,CAAC;QACjF,MAAM,CAAC,GAAG,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QAErC,QAAQ,CAAC,OAAO,EAAE,CAAC;QACnB,+BAAqB,CAAC,QAAQ,CAAC,IAAI,EAAE,SAAS,EAAE,iBAAM,EAAE,QAAQ,CAAC,cAAc,CAAC,CAAC;QAEjF,MAAM,CAAC,GAAG,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;IACvC,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,+DAA+D,EAAE;QAClE,IAAM,UAAU,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC;QACpC,IAAM,IAAI,GAAG,QAAQ,CAAC,IAAI,CAAC;QAE3B,KAAK,CAAC,IAAI,EAAE,kBAAkB,CAAC,CAAC;QAChC,KAAK,CAAC,IAAI,EAAE,qBAAqB,CAAC,CAAC;QAEnC,kBAAkB,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;QACnC,MAAM,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC,oBAAoB,CAAC,SAAS,EAAE,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE,IAAI,CAAC,CAAC;QAE3F,UAAU,CAAC,OAAO,EAAE,CAAC;QACrB,MAAM,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC,oBAAoB,CAAC,SAAS,EAAE,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE,IAAI,CAAC,CAAC;IAChG,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,mEAAmE,EAAE;QACtE,IAAM,UAAU,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC;QACpC,IAAM,UAAU,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC;QACpC,IAAM,aAAa,GAAG,OAAO,CAAC,SAAS,CAAC,+BAA+B,CAAC,CAAC;QAEzE,UAAU,CAAC,aAAa,EAAE,CAAC,SAAS,CAAC,aAAa,CAAC,CAAC;QACpD,kBAAkB,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;QACnC,kBAAkB,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;QAEnC,+BAAqB,CAAC,QAAQ,CAAC,IAAI,EAAE,SAAS,EAAE,iBAAM,CAAC,CAAC;QAExD,MAAM,CAAC,aAAa,CAAC,CAAC,gBAAgB,EAAE,CAAC;IAC3C,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,6DAA6D,EAAE;QAChE,IAAM,UAAU,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC;QACpC,IAAM,UAAU,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC;QACpC,IAAM,aAAa,GAAG,OAAO,CAAC,SAAS,CAAC,+BAA+B,CAAC,CAAC;QACzE,IAAM,aAAa,GAAG,OAAO,CAAC,SAAS,CAAC,+BAA+B,CAAC,CAAC;QAEzE,UAAU,CAAC,aAAa,EAAE,CAAC,SAAS,CAAC,aAAa,CAAC,CAAC;QACpD,UAAU,CAAC,aAAa,EAAE,CAAC,SAAS,CAAC,aAAa,CAAC,CAAC;QAEpD,kBAAkB,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;QACnC,kBAAkB,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;QACnC,kBAAkB,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;QAEnC,+BAAqB,CAAC,QAAQ,CAAC,IAAI,EAAE,SAAS,EAAE,iBAAM,CAAC,CAAC;QAExD,MAAM,CAAC,kBAAkB,CAAC,iBAAiB,CAAC,CAAC,OAAO,CAAC,CAAC,UAAU,EAAE,UAAU,CAAC,CAAC,CAAC;QAE/E,MAAM,CAAC,aAAa,CAAC,CAAC,GAAG,CAAC,gBAAgB,EAAE,CAAC;QAC7C,MAAM,CAAC,aAAa,CAAC,CAAC,gBAAgB,EAAE,CAAC;IAC3C,CAAC,CAAC,CAAC;AAEL,CAAC,CAAC,CAAC;AAMH;IAAA;IAAsB,CAAC;IAAjB,aAAa;QAHlB,gBAAS,CAAC;YACT,QAAQ,EAAE,OAAO;SAClB,CAAC;OACI,aAAa,CAAI;IAAD,oBAAC;CAAA,AAAvB,IAAuB;AAGvB,wDAAwD;AACxD,kDAAkD;AAMlD;IAAA;IAA4B,CAAC;IAAvB,mBAAmB;QALxB,eAAQ,CAAC;YACR,OAAO,EAAE,CAAC,aAAa,CAAC;YACxB,YAAY,EAAE,CAAC,aAAa,CAAC;YAC7B,eAAe,EAAE,CAAC,aAAa,CAAC;SACjC,CAAC;OACI,mBAAmB,CAAI;IAAD,0BAAC;CAAA,AAA7B,IAA6B","sourcesContent":["import {TestBed, inject} from '@angular/core/testing';\nimport {dispatchKeyboardEvent} from '@angular/cdk/testing';\nimport {ESCAPE} from '@angular/cdk/keycodes';\nimport {Component, NgModule} from '@angular/core';\nimport {OverlayModule, OverlayContainer, Overlay} from '../index';\nimport {OverlayKeyboardDispatcher} from './overlay-keyboard-dispatcher';\nimport {ComponentPortal} from '@angular/cdk/portal';\n\n\ndescribe('OverlayKeyboardDispatcher', () => {\n  let keyboardDispatcher: OverlayKeyboardDispatcher;\n  let overlay: Overlay;\n\n  beforeEach(() => {\n    TestBed.configureTestingModule({\n      imports: [OverlayModule, TestComponentModule],\n    });\n\n    inject([OverlayKeyboardDispatcher, Overlay], (kbd: OverlayKeyboardDispatcher, o: Overlay) => {\n      keyboardDispatcher = kbd;\n      overlay = o;\n    })();\n  });\n\n  afterEach(inject([OverlayContainer], (overlayContainer: OverlayContainer) => {\n    overlayContainer.ngOnDestroy();\n  }));\n\n  it('should track overlays in order as they are attached and detached', () => {\n    const overlayOne = overlay.create();\n    const overlayTwo = overlay.create();\n\n    // Attach overlays\n    keyboardDispatcher.add(overlayOne);\n    keyboardDispatcher.add(overlayTwo);\n\n    expect(keyboardDispatcher._attachedOverlays.length)\n        .toBe(2, 'Expected both overlays to be tracked.');\n    expect(keyboardDispatcher._attachedOverlays[0]).toBe(overlayOne, 'Expected one to be first.');\n    expect(keyboardDispatcher._attachedOverlays[1]).toBe(overlayTwo, 'Expected two to be last.');\n\n    // Detach first one and re-attach it\n    keyboardDispatcher.remove(overlayOne);\n    keyboardDispatcher.add(overlayOne);\n\n    expect(keyboardDispatcher._attachedOverlays[0])\n        .toBe(overlayTwo, 'Expected two to now be first.');\n    expect(keyboardDispatcher._attachedOverlays[1])\n        .toBe(overlayOne, 'Expected one to now be last.');\n  });\n\n  it('should dispatch body keyboard events to the most recently attached overlay', () => {\n    const overlayOne = overlay.create();\n    const overlayTwo = overlay.create();\n    const overlayOneSpy = jasmine.createSpy('overlayOne keyboard event spy');\n    const overlayTwoSpy = jasmine.createSpy('overlayTwo keyboard event spy');\n\n    overlayOne.keydownEvents().subscribe(overlayOneSpy);\n    overlayTwo.keydownEvents().subscribe(overlayTwoSpy);\n\n    // Attach overlays\n    keyboardDispatcher.add(overlayOne);\n    keyboardDispatcher.add(overlayTwo);\n\n    dispatchKeyboardEvent(document.body, 'keydown', ESCAPE);\n\n    // Most recent overlay should receive event\n    expect(overlayOneSpy).not.toHaveBeenCalled();\n    expect(overlayTwoSpy).toHaveBeenCalled();\n  });\n\n  it('should dispatch keyboard events when propagation is stopped', () => {\n    const overlayRef = overlay.create();\n    const spy = jasmine.createSpy('keyboard event spy');\n    const button = document.createElement('button');\n\n    document.body.appendChild(button);\n    button.addEventListener('keydown', event => event.stopPropagation());\n\n    overlayRef.keydownEvents().subscribe(spy);\n    keyboardDispatcher.add(overlayRef);\n    dispatchKeyboardEvent(button, 'keydown', ESCAPE);\n\n    expect(spy).toHaveBeenCalled();\n\n    button.parentNode!.removeChild(button);\n  });\n\n  it('should complete the keydown stream on dispose', () => {\n    const overlayRef = overlay.create();\n    const completeSpy = jasmine.createSpy('keydown complete spy');\n\n    overlayRef.keydownEvents().subscribe(undefined, undefined, completeSpy);\n\n    overlayRef.dispose();\n\n    expect(completeSpy).toHaveBeenCalled();\n  });\n\n  it('should stop emitting events to detached overlays', () => {\n    const instance = overlay.create();\n    const spy = jasmine.createSpy('keyboard event spy');\n\n    instance.attach(new ComponentPortal(TestComponent));\n    instance.keydownEvents().subscribe(spy);\n\n    dispatchKeyboardEvent(document.body, 'keydown', ESCAPE, instance.overlayElement);\n    expect(spy).toHaveBeenCalledTimes(1);\n\n    instance.detach();\n    dispatchKeyboardEvent(document.body, 'keydown', ESCAPE, instance.overlayElement);\n\n    expect(spy).toHaveBeenCalledTimes(1);\n  });\n\n  it('should stop emitting events to disposed overlays', () => {\n    const instance = overlay.create();\n    const spy = jasmine.createSpy('keyboard event spy');\n\n    instance.attach(new ComponentPortal(TestComponent));\n    instance.keydownEvents().subscribe(spy);\n\n    dispatchKeyboardEvent(document.body, 'keydown', ESCAPE, instance.overlayElement);\n    expect(spy).toHaveBeenCalledTimes(1);\n\n    instance.dispose();\n    dispatchKeyboardEvent(document.body, 'keydown', ESCAPE, instance.overlayElement);\n\n    expect(spy).toHaveBeenCalledTimes(1);\n  });\n\n  it('should dispose of the global keyboard event handler correctly', () => {\n    const overlayRef = overlay.create();\n    const body = document.body;\n\n    spyOn(body, 'addEventListener');\n    spyOn(body, 'removeEventListener');\n\n    keyboardDispatcher.add(overlayRef);\n    expect(body.addEventListener).toHaveBeenCalledWith('keydown', jasmine.any(Function), true);\n\n    overlayRef.dispose();\n    expect(body.removeEventListener).toHaveBeenCalledWith('keydown', jasmine.any(Function), true);\n  });\n\n  it('should skip overlays that do not have keydown event subscriptions', () => {\n    const overlayOne = overlay.create();\n    const overlayTwo = overlay.create();\n    const overlayOneSpy = jasmine.createSpy('overlayOne keyboard event spy');\n\n    overlayOne.keydownEvents().subscribe(overlayOneSpy);\n    keyboardDispatcher.add(overlayOne);\n    keyboardDispatcher.add(overlayTwo);\n\n    dispatchKeyboardEvent(document.body, 'keydown', ESCAPE);\n\n    expect(overlayOneSpy).toHaveBeenCalled();\n  });\n\n  it('should not add the same overlay to the stack multiple times', () => {\n    const overlayOne = overlay.create();\n    const overlayTwo = overlay.create();\n    const overlayOneSpy = jasmine.createSpy('overlayOne keyboard event spy');\n    const overlayTwoSpy = jasmine.createSpy('overlayTwo keyboard event spy');\n\n    overlayOne.keydownEvents().subscribe(overlayOneSpy);\n    overlayTwo.keydownEvents().subscribe(overlayTwoSpy);\n\n    keyboardDispatcher.add(overlayOne);\n    keyboardDispatcher.add(overlayTwo);\n    keyboardDispatcher.add(overlayOne);\n\n    dispatchKeyboardEvent(document.body, 'keydown', ESCAPE);\n\n    expect(keyboardDispatcher._attachedOverlays).toEqual([overlayTwo, overlayOne]);\n\n    expect(overlayTwoSpy).not.toHaveBeenCalled();\n    expect(overlayOneSpy).toHaveBeenCalled();\n  });\n\n});\n\n\n@Component({\n  template: 'Hello'\n})\nclass TestComponent { }\n\n\n// Create a real (non-test) NgModule as a workaround for\n// https://github.com/angular/angular/issues/10760\n@NgModule({\n  exports: [TestComponent],\n  declarations: [TestComponent],\n  entryComponents: [TestComponent],\n})\nclass TestComponentModule { }\n"]}